<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REFLECT // AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    
<style>
    :root {
        --bg-depth: #030303;
        --bg-surface: #0a0a0a;
        --bg-surface-2: #121212;
        --border-subtle: rgba(255, 255, 255, 0.08);
        --border-glow: rgba(124, 58, 237, 0.3);
        
        --primary-accent: #7c3aed; /* Electric Violet */
        --secondary-accent: #06b6d4; /* Cyan */
        --accent-gradient: linear-gradient(135deg, #7c3aed, #06b6d4);
        
        --text-main: #ededed;
        --text-muted: #888888;
        
        --glass-panel: rgba(10, 10, 10, 0.7);
        --blur: 20px;
        
        --font-display: 'Space Grotesk', sans-serif;
        --font-body: 'Inter', sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background-color: var(--bg-depth);
        color: var(--text-main);
        font-family: var(--font-body);
        height: 100vh;
        overflow: hidden;
        display: flex;
        /* Ambient background glow */
        background-image: 
            radial-gradient(circle at 15% 50%, rgba(124, 58, 237, 0.08), transparent 25%),
            radial-gradient(circle at 85% 30%, rgba(6, 182, 212, 0.08), transparent 25%);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-depth); }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* --- LAYOUT --- */
    
    .app-layout {
        display: flex;
        width: 100%;
        height: 100%;
        position: relative;
    }

    /* Sidebar */
    .sidebar {
        width: 280px;
        background: var(--bg-surface);
        border-right: 1px solid var(--border-subtle);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 100;
        padding: 24px 16px;
    }

    .sidebar.closed {
        transform: translateX(-100%);
        position: absolute;
        height: 100%;
    }

    .brand {
        font-family: var(--font-display);
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: -0.03em;
        margin-bottom: 32px;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .brand span { font-size: 0.8rem; opacity: 0.7; font-family: var(--font-mono); color: var(--text-muted); -webkit-text-fill-color: initial; }

    .sidebar-section { margin-bottom: 32px; }
    
    .sidebar-header {
        font-family: var(--font-mono);
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 12px;
        letter-spacing: 0.1em;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }
    
    .stat-val { font-family: var(--font-mono); color: var(--secondary-accent); }

    .history-item {
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        margin-bottom: 4px;
    }

    .history-item:hover {
        background: var(--bg-surface-2);
        border-color: var(--border-subtle);
    }

    .history-title { font-size: 0.9rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .history-preview { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

    /* Main Chat Area */
    .main-stage {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        background: rgba(0,0,0,0.2); /* Slight tint */
    }

    /* Top Bar */
    .top-bar {
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 32px;
        border-bottom: 1px solid var(--border-subtle);
        backdrop-filter: blur(var(--blur));
        background: rgba(3, 3, 3, 0.5);
        z-index: 10;
    }

    .top-left { display: flex; align-items: center; gap: 20px; }

    .toggle-sidebar-btn {
        background: transparent;
        border: 1px solid var(--border-subtle);
        color: var(--text-muted);
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: 0.2s;
    }
    .toggle-sidebar-btn:hover { color: var(--text-main); border-color: var(--text-muted); }

    /* Mode Switch - Cyberpunk Style */
    .mode-switch-container {
        display: flex;
        background: var(--bg-surface-2);
        padding: 4px;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
    }

    .mode-btn {
        padding: 6px 16px;
        font-size: 0.8rem;
        font-family: var(--font-mono);
        color: var(--text-muted);
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .mode-btn.active {
        background: var(--bg-surface);
        color: var(--text-main);
        box-shadow: 0 0 15px rgba(124, 58, 237, 0.15);
        border: 1px solid var(--border-subtle);
    }
    
    .actions { display: flex; gap: 10px; }
    .action-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 0.85rem;
        cursor: pointer;
        padding: 8px 12px;
        transition: 0.2s;
        border-radius: 6px;
    }
    .action-btn:hover { background: var(--bg-surface-2); color: var(--text-main); }


    /* Chat Container */
    .chat-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: 40px 0;
        display: flex;
        flex-direction: column;
        scroll-behavior: smooth;
    }

    .container-width {
        max-width: 900px;
        width: 90%;
        margin: 0 auto;
    }

    /* Welcome State */
    .welcome-screen {
        margin-top: 5vh;
        text-align: left;
    }

    .welcome-title {
        font-family: var(--font-display);
        font-size: 3rem;
        line-height: 1.1;
        margin-bottom: 16px;
        background: linear-gradient(to right, #fff, #888);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .welcome-subtitle {
        font-size: 1.1rem;
        color: var(--text-muted);
        max-width: 600px;
        margin-bottom: 40px;
        font-weight: 300;
    }

    .grid-options {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
    }

    .option-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        padding: 24px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .option-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; width: 2px; height: 100%;
        background: var(--secondary-accent);
        opacity: 0;
        transition: 0.3s;
    }

    .option-card:hover {
        transform: translateY(-2px);
        border-color: rgba(255,255,255,0.2);
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
    }

    .option-card:hover::before { opacity: 1; }

    .card-icon { font-size: 1.5rem; margin-bottom: 16px; display: block; }
    .card-title { font-family: var(--font-display); font-size: 1.1rem; margin-bottom: 8px; color: var(--text-main); }
    .card-desc { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; }


    /* Messages */
    .message {
        margin-bottom: 24px;
        animation: fadeSlideIn 0.4s ease forwards;
        opacity: 0;
        transform: translateY(10px);
    }

    @keyframes fadeSlideIn { to { opacity: 1; transform: translateY(0); } }

    .message-content {
        padding: 20px 24px;
        border-radius: 4px 20px 20px 20px;
        font-size: 1.05rem;
        line-height: 1.6;
        position: relative;
        max-width: 85%;
    }

    .message.user {
        display: flex;
        justify-content: flex-end;
    }

    .message.user .message-content {
        background: var(--bg-surface-2);
        border: 1px solid var(--border-subtle);
        border-radius: 20px 4px 20px 20px;
        /* Subtle purple glow for user */
        box-shadow: inset 0 0 20px rgba(124, 58, 237, 0.05);
    }

    .message.ai .message-content {
        background: transparent;
        border-left: 2px solid var(--secondary-accent);
        border-radius: 0 12px 12px 0;
        padding-left: 24px;
    }
    
    .ai-label {
        font-family: var(--font-mono);
        font-size: 0.75rem;
        color: var(--secondary-accent);
        margin-bottom: 8px;
        display: block;
        letter-spacing: 0.1em;
    }

    /* Hints & Interactive Elements in Chat */
    .hint-level {
        display: inline-block;
        font-family: var(--font-mono);
        font-size: 0.75rem;
        color: var(--primary-accent);
        border: 1px solid var(--primary-accent);
        padding: 4px 8px;
        border-radius: 4px;
        margin-bottom: 12px;
        background: rgba(124, 58, 237, 0.1);
    }

    .reflection-gate {
        background: rgba(6, 182, 212, 0.05);
        border: 1px solid rgba(6, 182, 212, 0.2);
        padding: 20px;
        border-radius: 12px;
        margin: 10px 0;
    }

    button.hint-button, button.answer-button {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        color: var(--text-main);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-family: var(--font-mono);
        font-size: 0.85rem;
        transition: all 0.2s;
    }

    button.hint-button:hover {
        border-color: var(--secondary-accent);
        color: var(--secondary-accent);
        box-shadow: 0 0 10px rgba(6, 182, 212, 0.1);
    }

    button.answer-button:hover {
        border-color: #ef4444;
        color: #ef4444;
    }

    /* Input Area - The HUD */
    .input-wrapper {
        padding: 0 32px 32px 32px;
        background: linear-gradient(to top, var(--bg-depth) 80%, transparent);
    }

    .input-box-container {
        position: relative;
        max-width: 900px;
        margin: 0 auto;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 8px;
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .input-box-container:focus-within {
        border-color: var(--primary-accent);
        box-shadow: 0 0 20px rgba(124, 58, 237, 0.15);
    }

    textarea.input-field {
        width: 100%;
        background: transparent;
        border: none;
        color: #fff;
        padding: 12px 16px;
        font-family: var(--font-body);
        font-size: 1rem;
        resize: none;
        outline: none;
        max-height: 200px;
    }
    
    textarea.input-field::placeholder { color: #555; }

    .input-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 12px 8px 16px;
    }

    .char-limit {
        font-family: var(--font-mono);
        font-size: 0.7rem;
        color: #444;
    }

    .send-btn {
        background: var(--text-main);
        color: var(--bg-depth);
        border: none;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s;
        font-weight: bold;
    }

    .send-btn:hover { transform: scale(1.05); }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Loading Animation */
    .loading-wave {
        display: flex;
        align-items: center;
        gap: 4px;
        height: 20px;
    }
    .bar {
        width: 4px;
        background: var(--secondary-accent);
        animation: wave 1s infinite ease-in-out;
        border-radius: 2px;
    }
    .bar:nth-child(1) { height: 10px; animation-delay: 0.0s; }
    .bar:nth-child(2) { height: 16px; animation-delay: 0.1s; }
    .bar:nth-child(3) { height: 12px; animation-delay: 0.2s; }
    
    @keyframes wave {
        0%, 100% { transform: scaleY(1); opacity: 0.5; }
        50% { transform: scaleY(1.5); opacity: 1; }
    }

    /* API Key Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal-content {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        font-family: var(--font-display);
        font-size: 1.5rem;
        margin-bottom: 16px;
        color: var(--text-main);
    }

    .modal-body {
        margin-bottom: 24px;
    }

    .modal-label {
        display: block;
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 8px;
        font-family: var(--font-mono);
    }

    .modal-input {
        width: 100%;
        background: var(--bg-surface-2);
        border: 1px solid var(--border-subtle);
        color: var(--text-main);
        padding: 12px 16px;
        border-radius: 8px;
        font-family: var(--font-mono);
        font-size: 0.9rem;
        margin-bottom: 12px;
    }

    .modal-input:focus {
        outline: none;
        border-color: var(--primary-accent);
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .modal-link {
        color: var(--secondary-accent);
        text-decoration: none;
        font-size: 0.85rem;
    }

    .modal-link:hover {
        text-decoration: underline;
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-family: var(--font-mono);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid var(--border-subtle);
    }

    .modal-btn-primary {
        background: var(--primary-accent);
        color: white;
        border-color: var(--primary-accent);
    }

    .modal-btn-primary:hover {
        background: #6d28d9;
        transform: translateY(-1px);
    }

    .modal-btn-secondary {
        background: transparent;
        color: var(--text-muted);
    }

    .modal-btn-secondary:hover {
        background: var(--bg-surface-2);
        color: var(--text-main);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .sidebar { position: absolute; height: 100%; transform: translateX(-100%); }
        .sidebar.open { transform: translateX(0); }
        .top-bar { padding: 0 16px; }
        .input-wrapper { padding: 0 16px 20px 16px; }
        .welcome-title { font-size: 2rem; }
        .modal-content {
            padding: 24px;
            width: 95%;
        }
    }

</style>
</head>
<body>

    <div class="app-layout">
        
        <aside class="sidebar" id="sidebar">
            <div class="brand">
                REFLECT // AI <span>v2.0</span>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-header">Stats</div>
                <div class="stat-row">
                    <span>Problems Solved</span>
                    <span class="stat-val" id="problemsSolved">0</span>
                </div>
                <div class="stat-row">
                    <span>Hints Used</span>
                    <span class="stat-val" id="hintsUsed">0</span>
                </div>
            </div>

            <div class="sidebar-section" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div class="sidebar-header">History</div>
                <div id="conversationHistory" style="overflow-y: auto; flex: 1; padding-right: 5px;">
                    </div>
            </div>
        </aside>

        <main class="main-stage">
            
            <header class="top-bar">
                <div class="top-left">
                    <button class="toggle-sidebar-btn" onclick="toggleSidebar()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    
                    <div class="mode-switch-container">
                        <div class="mode-btn active" id="learnModeBtn" onclick="setMode('learning')">LEARN</div>
                        <div class="mode-btn" id="quickModeBtn" onclick="setMode('quick')">QUICK</div>
                    </div>
                </div>

                <div class="actions">
                    <button class="action-btn" id="apiKeyStatus" onclick="promptForApiKey()" title="Set Groq API Key" style="color: #ef4444;">‚ö† API Key</button>
                    <button class="action-btn" onclick="exportConversation()" title="Export JSON">Export</button>
                    <button class="action-btn" onclick="clearConversation()" title="Clear Chat">Clear</button>
                </div>
            </header>

            <div class="chat-wrapper" id="chatContainer">
                <div class="container-width">
                    
                    <div id="welcomeCard" class="welcome-screen">
                        <h1 class="welcome-title">Thinking first.<br>Answering second.</h1>
                        <p class="welcome-subtitle">Select a domain to begin your training session. I will guide you through the problem-solving process rather than just giving you the solution.</p>
                        
                        <div class="grid-options">
                            <div class="option-card" onclick="loadExample('dsa')">
                                <span class="card-icon">‚ö°</span>
                                <div class="card-title">Algorithms</div>
                                <div class="card-desc">Arrays, Trees, DP & Graph theory problems.</div>
                            </div>
                            <div class="option-card" onclick="loadExample('system')">
                                <span class="card-icon">üèóÔ∏è</span>
                                <div class="card-title">System Design</div>
                                <div class="card-desc">Scalability, Load Balancing & Architecture.</div>
                            </div>
                            <div class="option-card" onclick="loadExample('coding')">
                                <span class="card-icon">üíª</span>
                                <div class="card-title">Live Coding</div>
                                <div class="card-desc">Debug and optimize raw code snippets.</div>
                            </div>
                            <div class="option-card" onclick="loadExample('aptitude')">
                                <span class="card-icon">üßÆ</span>
                                <div class="card-title">Quant</div>
                                <div class="card-desc">Mathematical reasoning and logic puzzles.</div>
                            </div>
                        </div>
                    </div>

                    <div id="messages">
                        </div>

                </div>
            </div>

            <div class="input-wrapper">
                <div class="input-box-container">
                    <textarea 
                        id="messageInput" 
                        class="input-field" 
                        rows="1" 
                        placeholder="Initialize problem statement..."
                    ></textarea>
                    <div class="input-footer">
                        <div class="char-limit" id="charCount"></div>
                        <button class="send-btn" id="sendButton" onclick="sendMessage()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal-content">
            <div class="modal-header">Set Groq API Key</div>
            <div class="modal-body">
                <label class="modal-label">Enter your Groq API Key:</label>
                <input 
                    type="password" 
                    id="apiKeyInput" 
                    class="modal-input" 
                    placeholder="gsk_..."
                    autocomplete="off"
                />
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px;">
                    Don't have an API key? Get one free from 
                    <a href="https://console.groq.com" target="_blank" class="modal-link">console.groq.com</a>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; font-style: italic;">
                    Your API key is stored locally in your browser and never sent to our servers.
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeApiKeyModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveApiKeyFromModal()">Save API Key</button>
            </div>
        </div>
    </div>

    <!-- Load external scripts -->
    <script src="config.js"></script>
    <script src="utils.js"></script>

    <script>
        // Ensure Utils and Config are available (fallback if files don't load)
        if (typeof Utils === 'undefined') {
            window.Utils = {
            validateMessage: (msg) => msg && msg.length > 0,
                sanitizeMessage: (msg) => {
                    if (!msg || typeof msg !== 'string') return '';
                    return msg.replace(/</g, "&lt;").replace(/>/g, "&gt;").trim().substring(0, 2000);
                },
                showToast: (msg, type) => {
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#4f46e5;color:white;padding:12px 20px;border-radius:8px;z-index:10000;';
                    toast.textContent = msg;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                },
                formatErrorMessage: (error) => {
                    if (error.includes('401')) return 'Invalid API key. Please check your Groq API key.';
                    if (error.includes('429')) return 'Rate limit exceeded. Please wait a moment.';
                    if (error.includes('network')) return 'Network error. Check your connection.';
                    return 'An error occurred. Please try again.';
                }
            };
        }

        if (typeof Config === 'undefined') {
            window.Config = {
                api: {
                    baseUrl: 'https://api.groq.com/openai/v1/chat/completions',
                    model: 'llama-3.1-8b-instant',
                    temperature: 0.7,
                    maxTokens: 400
                },
                app: {
                    maxHints: 4,
                    characterLimit: 2000
                },
                prompts: {
                    hint: {
                        1: 'You are Reflect AI helping with placement prep. Give a gentle, SPECIFIC hint about the algorithm or approach needed.',
                        2: 'You are Reflect AI. Give a MORE SPECIFIC hint about the exact technique.',
                        3: 'You are Reflect AI. Give STEP-BY-STEP guidance about the algorithm without writing code.'
                    },
                    final: 'You are Reflect AI providing the COMPLETE SOLUTION to the specific problem.',
                    feedback: 'You are Reflect AI. Give specific, constructive feedback.',
                    quick: 'You are a helpful AI assistant in Quick Mode. Provide direct, helpful answers.'
                }
            };
        }

        // App State
        let conversationState = {
            mode: 'learning',
            currentProblem: null,
            reflectionComplete: false,
            hintLevel: 0,
            maxHints: Config.app.maxHints || 4,
            messages: [],
            conversationHistory: [],
            problemsSolved: 0,
            hintsUsed: 0,
            apiKey: null
        };

        // API Key Management
        function getApiKey() {
            if (!conversationState.apiKey) {
                conversationState.apiKey = localStorage.getItem('groq_api_key');
            }
            return conversationState.apiKey;
        }

        function setApiKey(key) {
            conversationState.apiKey = key;
            localStorage.setItem('groq_api_key', key);
            updateApiKeyStatus();
        }

        function updateApiKeyStatus() {
            const apiKeyBtn = document.getElementById('apiKeyStatus');
            if (apiKeyBtn) {
                const hasKey = !!getApiKey();
                apiKeyBtn.textContent = hasKey ? '‚úì API Key' : '‚ö† API Key';
                apiKeyBtn.style.color = hasKey ? '#10b981' : '#ef4444';
                apiKeyBtn.title = hasKey ? 'Groq API Key is set' : 'Set Groq API Key (Required)';
            }
        }

        function promptForApiKey() {
            const modal = document.getElementById('apiKeyModal');
            const input = document.getElementById('apiKeyInput');
            if (modal && input) {
                modal.classList.add('show');
                input.value = '';
                input.focus();
                // Close on Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        closeApiKeyModal();
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
                // Close on overlay click
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        closeApiKeyModal();
                    }
                };
            } else {
                // Fallback to prompt if modal elements don't exist
                const key = prompt('Please enter your Groq API key (get one free from console.groq.com):\n\nYour API key will be stored locally in your browser.', '');
                if (key && key.trim()) {
                    if (key.trim().startsWith('gsk_')) {
                        setApiKey(key.trim());
                        Utils.showToast('API key saved successfully!', 'success');
                        return true;
                    } else {
                        Utils.showToast('Invalid API key format. Groq keys start with "gsk_"', 'error');
                        return false;
                    }
                }
            }
            return false;
        }

        function closeApiKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        function saveApiKeyFromModal() {
            const input = document.getElementById('apiKeyInput');
            if (!input) return;
            
            const key = input.value.trim();
            if (!key) {
                Utils.showToast('Please enter an API key', 'error');
                input.focus();
                return;
            }
            
            if (!key.startsWith('gsk_')) {
                Utils.showToast('Invalid API key format. Groq keys start with "gsk_"', 'error');
                input.focus();
                input.select();
                return;
            }
            
            setApiKey(key);
            closeApiKeyModal();
            Utils.showToast('API key saved successfully!', 'success');
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Check for API key
            if (!getApiKey()) {
                // Show modal after a short delay for better UX
                setTimeout(() => {
                    promptForApiKey();
                }, 500);
            }

            loadSavedState();
            initializeSidebar();
            
            // Auto-resize textarea
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
                const charCount = this.value.length;
                document.getElementById('charCount').textContent = `${charCount} / ${Config.app.characterLimit || 2000}`;
            });

            // Enter key
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Enter key in API key modal
            const apiKeyInput = document.getElementById('apiKeyInput');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveApiKeyFromModal();
                    }
                });
            }

            // Update API key status indicator
            updateApiKeyStatus();
        });

        // --- VISUAL LOGIC ---

        function setMode(mode) {
            const previousMode = conversationState.mode;
            conversationState.mode = mode;
            document.getElementById('learnModeBtn').classList.toggle('active', mode === 'learning');
            document.getElementById('quickModeBtn').classList.toggle('active', mode === 'quick');
            
            const input = document.getElementById('messageInput');
            input.placeholder = mode === 'learning' ? 
                "Initialize problem statement..." : 
                "Quick query injection...";
            
            // Reset reflection state when switching modes to allow fresh start
            if (previousMode !== mode) {
                conversationState.reflectionComplete = false;
                conversationState.hintLevel = 0;
                conversationState.currentProblem = null;
            }
            
            Utils.showToast(`Switched to ${mode === 'learning' ? 'Learning' : 'Quick'} Mode`, 'success');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('closed');
        }

        function initializeSidebar() {
            if(window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('closed');
            } else {
                document.getElementById('sidebar').classList.add('closed');
            }
        }

        // --- CORE LOGIC ---

        function loadExample(type) {
            const examples = {
                dsa: "Find the maximum sum subarray in: [-2, 1, -3, 4, -1, 2, 1, -5, 4]. What algorithm should I use?",
                aptitude: "If a train travels at 60 km/h for the first half of the journey and 40 km/h for the second half, what's the average speed?",
                coding: "Write a function to reverse a linked list. I know the basic structure but I'm confused about the pointer manipulation.",
                system: "Design a URL shortener like bit.ly. How would you handle millions of requests per day?"
            };
            document.getElementById('messageInput').value = examples[type] || '';
            document.getElementById('messageInput').focus();
        }

        async function callGroqAPI(messages, systemPrompt) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('API key not set. Please set your Groq API key.');
            }

            const requestBody = {
                model: Config.api.model,
                messages: [
                    { role: 'system', content: systemPrompt },
                    ...messages
                ],
                temperature: Config.api.temperature,
                max_tokens: Config.api.maxTokens
            };

            const response = await fetch(Config.api.baseUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('Unexpected response format from API');
            }

            return data.choices[0].message.content.trim();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!Utils.validateMessage(message)) {
                Utils.showToast('Please enter a valid message.', 'error');
                return;
            }

            // Check API key
            if (!getApiKey()) {
                Utils.showToast('Please set your Groq API key first.', 'error');
                if (promptForApiKey()) {
                    // Retry after setting key
                    input.value = message;
                    setTimeout(() => sendMessage(), 100);
                }
                return;
            }

            // Hide Welcome Screen on first message
            document.getElementById('welcomeCard').style.display = 'none';

            // UI Updates
            addMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';
            input.disabled = true;
            
            // Show Loading
            showLoading();

            try {
                const userMessage = { role: 'user', content: message };
                conversationState.messages.push(userMessage);

                let systemPrompt;
                let responseContent;

                if (conversationState.mode === 'learning' && !conversationState.reflectionComplete) {
                    // First message in Learning Mode - Reflection Protocol
                    conversationState.currentProblem = message;
                    
                    // Use a reflection-focused prompt for initial understanding
                    const reflectionPrompt = `You are Reflect AI, a learning assistant for placement preparation. The student has just shared a problem they want to solve.

Your goal is to help them THINK through the problem, not solve it for them.

Ask 1-2 thoughtful questions to understand:
1. What they already understand about the problem
2. What approach they're considering
3. What specific part is confusing or blocking them

Be encouraging and guide them to reflect on their current understanding. Don't give hints or solutions yet - just help them articulate their thinking.

Keep your response to 2-3 sentences max.`;
                    
                    responseContent = await callGroqAPI([userMessage], reflectionPrompt);
                    
                        const reflectionRequest = `
                            <span class="ai-label">SYSTEM // REFLECTION PROTOCOL</span>
                        ${responseContent.replace(/\n/g, '<br>')}
                            <div class="reflection-gate">
                            <strong>üí≠ Think First:</strong> Before we dive into solutions, help me understand your current thinking. What approach are you considering? What specific constraints or challenges are you facing?
                            </div>
                        `;
                        finishResponse(reflectionRequest);
                    conversationState.reflectionComplete = true;
                } else {
                    // Subsequent messages - Continue conversation
                    if (conversationState.mode === 'quick') {
                        systemPrompt = Config.prompts.quick;
                    } else {
                        // Learning Mode: Use feedback prompt to guide student
                        systemPrompt = Config.prompts.feedback || 'You are Reflect AI. The student is working through a problem. Give constructive feedback and guide them, but don\'t solve it completely. Encourage them to think through the next steps.';
                    }
                    
                    responseContent = await callGroqAPI(conversationState.messages, systemPrompt);
                    
                    // Only show hint/solution buttons in Learning Mode (after reflection is complete)
                    let actionButtons = '';
                    if (conversationState.mode === 'learning' && conversationState.reflectionComplete) {
                        actionButtons = `
                            <div style="margin-top:15px">
                                <button class="hint-button" onclick="requestHint()">Access Hint Module</button>
                                <button class="answer-button" onclick="requestSolution()">Decrypt Solution</button>
                            </div>
                        `;
                    }
                    
                    const formattedResponse = `
                        <span class="ai-label">SYSTEM // ${conversationState.mode === 'quick' ? 'QUICK RESPONSE' : 'LEARNING GUIDE'}</span>
                        ${responseContent.replace(/\n/g, '<br>')}
                        ${actionButtons}
                    `;
                    finishResponse(formattedResponse);
                }

                // Save conversation history
                saveConversationHistory();
                
            } catch (error) {
                console.error('API Error:', error);
                const errorMsg = Utils.formatErrorMessage(error.message);
                finishResponse(`<span class="ai-label">ERROR</span><br>${errorMsg}<br><br>Please check your API key or try again later.`);
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        async function requestHint() {
            // Only allow hints in Learning Mode
            if (conversationState.mode !== 'learning') {
                Utils.showToast('Hints are only available in Learning Mode. Switch to Learning Mode to use hints.', 'error');
                return;
            }

            if (conversationState.hintLevel >= conversationState.maxHints) {
                Utils.showToast('Maximum hints reached. Request solution instead.', 'error');
                return;
            }

            conversationState.hintLevel++;
            conversationState.hintsUsed++;
            updateStats();

            const hintPrompt = Config.prompts.hint[conversationState.hintLevel] || Config.prompts.hint[1];
            
            // Add context about the current problem
            const enhancedHintPrompt = `${hintPrompt}

IMPORTANT: The student is working on this problem: "${conversationState.currentProblem || 'the problem discussed in the conversation'}"

Give a hint that is specific to THIS problem, not generic advice.`;
            
            showLoading();
            try {
                const hintResponse = await callGroqAPI(
                    conversationState.messages,
                    enhancedHintPrompt
                );
                
                const formattedHint = `
                    <span class="hint-level">HINT LEVEL ${conversationState.hintLevel}</span>
                    ${hintResponse.replace(/\n/g, '<br>')}
                `;
                finishResponse(formattedHint);
            } catch (error) {
                finishResponse(`Error getting hint: ${Utils.formatErrorMessage(error.message)}`);
            }
        }

        async function requestSolution() {
            // Only allow solution requests in Learning Mode
            if (conversationState.mode !== 'learning') {
                Utils.showToast('Solutions are only available in Learning Mode. Switch to Learning Mode to use this feature.', 'error');
                return;
            }

            showLoading();
            try {
                // Enhance final solution prompt with problem context
                const enhancedFinalPrompt = `${Config.prompts.final}

IMPORTANT: The student is working on this problem: "${conversationState.currentProblem || 'the problem discussed in the conversation'}"

Provide a complete solution to THIS specific problem, including code if applicable.`;
                
                const solutionResponse = await callGroqAPI(
                    conversationState.messages,
                    enhancedFinalPrompt
                );
                
                conversationState.problemsSolved++;
                updateStats();
                
                const formattedSolution = `
                    <span class="ai-label">COMPLETE SOLUTION</span>
                    ${solutionResponse.replace(/\n/g, '<br>')}
                `;
                finishResponse(formattedSolution);
            } catch (error) {
                finishResponse(`Error getting solution: ${Utils.formatErrorMessage(error.message)}`);
            }
        }

        function addMessage(content, sender) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            
            const innerContent = sender === 'ai' ? content : Utils.sanitizeMessage(content);
            
            div.innerHTML = `<div class="message-content">${innerContent}</div>`;
            container.appendChild(div);
            
            const chatWrapper = document.getElementById('chatContainer');
            chatWrapper.scrollTo({ top: chatWrapper.scrollHeight, behavior: 'smooth' });
        }

        function showLoading() {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message ai loading-msg';
            div.innerHTML = `
                <div class="message-content">
                    <span class="ai-label">PROCESSING</span>
                    <div class="loading-wave">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            const chatWrapper = document.getElementById('chatContainer');
            chatWrapper.scrollTo({ top: chatWrapper.scrollHeight, behavior: 'smooth' });
        }

        function finishResponse(content) {
            const loader = document.querySelector('.loading-msg');
            if (loader) loader.remove();
            
            addMessage(content, 'ai');
            const input = document.getElementById('messageInput');
            input.disabled = false;
            input.focus();
        }

        function updateStats() {
            document.getElementById('problemsSolved').textContent = conversationState.problemsSolved;
            document.getElementById('hintsUsed').textContent = conversationState.hintsUsed;
            saveState();
        }

        function saveState() {
            localStorage.setItem('reflectai_state', JSON.stringify({
                problemsSolved: conversationState.problemsSolved,
                hintsUsed: conversationState.hintsUsed,
                conversationHistory: conversationState.conversationHistory
            }));
        }

        function saveConversationHistory() {
            if (conversationState.currentProblem) {
                const historyItem = {
                    id: Date.now().toString(),
                    title: conversationState.currentProblem.substring(0, 50),
                    preview: conversationState.messages[conversationState.messages.length - 1]?.content?.substring(0, 100) || '',
                    timestamp: Date.now()
                };
                
                conversationState.conversationHistory.unshift(historyItem);
                if (conversationState.conversationHistory.length > 50) {
                    conversationState.conversationHistory.pop();
                }
                
                updateHistoryDisplay();
                saveState();
            }
        }

        function updateHistoryDisplay() {
            const historyContainer = document.getElementById('conversationHistory');
            historyContainer.innerHTML = '';
            
            conversationState.conversationHistory.forEach(item => {
                const hItem = document.createElement('div');
                hItem.className = 'history-item';
                hItem.onclick = () => {
                    // Could implement conversation restoration here
                    Utils.showToast('Conversation history click - feature coming soon', 'info');
                };
                hItem.innerHTML = `
                    <div class="history-title">${Utils.sanitizeMessage(item.title)}</div>
                    <div class="history-preview">${Utils.sanitizeMessage(item.preview)}</div>
                `;
                historyContainer.appendChild(hItem);
            });
        }
        
        function loadSavedState() {
            try {
                const saved = localStorage.getItem('reflectai_state');
                if (saved) {
                    const state = JSON.parse(saved);
                    conversationState.problemsSolved = state.problemsSolved || 0;
                    conversationState.hintsUsed = state.hintsUsed || 0;
                    conversationState.conversationHistory = state.conversationHistory || [];
                }
            } catch (e) {
                console.error('Error loading saved state:', e);
            }
            
            document.getElementById('problemsSolved').textContent = conversationState.problemsSolved;
            document.getElementById('hintsUsed').textContent = conversationState.hintsUsed;
            updateHistoryDisplay();
        }
        
        function exportConversation() {
            const exportData = {
                timestamp: new Date().toISOString(),
                mode: conversationState.mode,
                messages: conversationState.messages,
                stats: {
                    problemsSolved: conversationState.problemsSolved,
                    hintsUsed: conversationState.hintsUsed
                }
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reflectai-export-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            Utils.showToast('Conversation exported successfully!', 'success');
        }
        
        function clearConversation() { 
            if (confirm('Are you sure you want to clear the current conversation?')) {
            document.getElementById('messages').innerHTML = ''; 
            document.getElementById('welcomeCard').style.display = 'block';
                conversationState.messages = [];
                conversationState.reflectionComplete = false;
                conversationState.hintLevel = 0;
                conversationState.currentProblem = null;
                Utils.showToast('Conversation cleared', 'success');
            }
        }

        // Make functions globally available
        window.setMode = setMode;
        window.toggleSidebar = toggleSidebar;
        window.loadExample = loadExample;
        window.sendMessage = sendMessage;
        window.requestHint = requestHint;
        window.requestSolution = requestSolution;
        window.exportConversation = exportConversation;
        window.clearConversation = clearConversation;
        window.promptForApiKey = promptForApiKey;
        window.closeApiKeyModal = closeApiKeyModal;
        window.saveApiKeyFromModal = saveApiKeyFromModal;
    </script>
</body>
</html>